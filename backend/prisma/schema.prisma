// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATIONS
// ============================================================================

model Organization {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?

  // Platform org flag (id=1, slug="platform")
  isPlatform  Boolean  @default(false)

  // Soft delete
  isActive    Boolean  @default(true)
  deletedAt   DateTime?

  // Organization-specific configurations (JSONB)
  config      Json     @default("{}")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users               OrganizationUser[]
  roles               Role[]
  featureFlags        OrganizationFeatureFlag[]
  invitations         Invitation[]
  projects            Project[]
  planItemTypes       PlanItemType[]
  contentTypes        ContentType[]
  activityItemTypes   ActivityItemType[]

  @@index([slug])
  @@index([isActive])
}

// ============================================================================
// PROJECTS (AI Project Manager Core)
// ============================================================================

model Project {
  id              String    @id @default(uuid())
  organizationId  Int

  name            String
  client          String?
  description     String?

  // Dates
  startDate       DateTime  @db.Date
  targetEndDate   DateTime? @db.Date

  // Status
  status          String    @default("active") // active, completed, on_hold, cancelled

  // Custom configuration for status reports
  statusConfig    Json      @default("{}")

  // Soft delete
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planItems       PlanItem[]
  contentItems    ContentItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([status])
  @@index([isActive])
}

// ============================================================================
// PLAN ITEM TYPES (Hierarchy Levels)
// ============================================================================

model PlanItemType {
  id             Int          @id @default(autoincrement())
  uuid           String       @unique @default(uuid())

  // Nullable for global/system types, set for org-specific
  organizationId Int?

  name           String
  slug           String
  description    String?

  // Hierarchy level: 1=workstream, 2=milestone, 3=activity, 4=task, 5=subtask
  level          Int          @default(1)

  // UI properties
  icon           String?
  color          String?

  // System types cannot be deleted or modified by org admins
  isSystem       Boolean      @default(false)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planItems      PlanItem[]

  @@unique([slug, organizationId])
  @@index([level])
  @@index([isActive])
}

// ============================================================================
// PLAN ITEMS (Hierarchical Project Plan Structure)
// ============================================================================

model PlanItem {
  id              String    @id @default(uuid())
  projectId       String

  // Self-referential hierarchy
  parentId        String?

  // Type determines the level (workstream, milestone, etc.)
  itemTypeId      Int

  // Core fields
  name            String
  description     String?
  owner           String?

  // Status: not_started, in_progress, completed, on_hold, cancelled
  status          String    @default("not_started")

  // Dates
  startDate       DateTime? @db.Date
  targetEndDate   DateTime? @db.Date
  actualStartDate DateTime? @db.Date
  actualEndDate   DateTime? @db.Date

  // Notes and references (links to ContentItems)
  notes           String?
  references      String[]  @default([])

  // Tree structure optimization
  sortOrder       Int       @default(0)
  path            String    @default("")  // Materialized path: /uuid1/uuid2/uuid3
  depth           Int       @default(0)

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent          PlanItem? @relation("PlanItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        PlanItem[] @relation("PlanItemHierarchy")
  itemType        PlanItemType @relation(fields: [itemTypeId], references: [id])
  history         PlanItemHistory[]

  @@index([projectId])
  @@index([parentId])
  @@index([itemTypeId])
  @@index([status])
  @@index([path])
  @@index([isActive])
}

// ============================================================================
// PLAN ITEM HISTORY (Audit Trail)
// ============================================================================

model PlanItemHistory {
  id              Int       @id @default(autoincrement())
  planItemId      String

  // What changed
  field           String
  oldValue        String?
  newValue        String?

  // Who changed it
  changedByUserId Int?
  changedByEmail  String?

  // Context
  changeReason    String?

  createdAt       DateTime  @default(now())

  // Relations
  planItem        PlanItem  @relation(fields: [planItemId], references: [id], onDelete: Cascade)

  @@index([planItemId])
  @@index([createdAt])
}

// ============================================================================
// USERS
// ============================================================================

model User {
  id                  Int       @id @default(autoincrement())
  uuid                String    @unique @default(uuid())
  email               String    @unique
  passwordHash        String

  // Profile
  firstName           String
  lastName            String
  avatarUrl           String?

  // Email verification
  emailVerified       Boolean   @default(false)
  emailVerifiedAt     DateTime?
  emailVerificationToken String? @unique
  emailVerificationExpires DateTime?

  // Password reset
  passwordResetToken  String?   @unique
  passwordResetExpires DateTime?

  // Account status
  isActive            Boolean   @default(true)
  lastLoginAt         DateTime?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  organizations       OrganizationUser[]
  refreshTokens       RefreshToken[]
  invitationsSent     Invitation[]       @relation("InvitationSender")
  contentItems        ContentItem[]

  @@index([email])
  @@index([isActive])
}

// ============================================================================
// USER-ORGANIZATION MEMBERSHIP (Many-to-Many with Role)
// ============================================================================

model OrganizationUser {
  id             Int          @id @default(autoincrement())

  userId         Int
  organizationId Int
  roleId         Int

  // Membership status
  isActive       Boolean      @default(true)
  joinedAt       DateTime     @default(now())

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([roleId])
}

// ============================================================================
// ROLES
// ============================================================================

model Role {
  id             Int          @id @default(autoincrement())
  uuid           String       @unique @default(uuid())
  name           String
  slug           String
  description    String?

  // Role hierarchy level (higher = more permissions)
  // 10=viewer, 20=standard, 30=advanced, 40=org_admin, 100=platform_admin
  level          Int          @default(10)

  // System roles cannot be deleted or modified
  isSystem       Boolean      @default(false)

  // Scope: "platform" = available across platform, "organization" = org-specific
  scope          RoleScope    @default(ORGANIZATION)

  // If org-specific, which org owns it (null for platform-level roles)
  organizationId Int?

  // Base role this was created from (for inheritance)
  baseRoleId     Int?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  baseRole       Role?        @relation("RoleInheritance", fields: [baseRoleId], references: [id])
  derivedRoles   Role[]       @relation("RoleInheritance")
  permissions    RolePermission[]
  users          OrganizationUser[]

  @@unique([slug, organizationId])
  @@index([scope])
  @@index([level])
}

enum RoleScope {
  PLATFORM
  ORGANIZATION
}

// ============================================================================
// MENUS (Pages/Sections in the UI)
// ============================================================================

model Menu {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())
  name         String
  slug         String   @unique
  description  String?

  // Menu hierarchy
  parentId     Int?
  parent       Menu?    @relation("MenuHierarchy", fields: [parentId], references: [id])
  children     Menu[]   @relation("MenuHierarchy")

  // UI properties
  icon         String?
  path         String
  sortOrder    Int      @default(0)

  // Visibility
  isActive     Boolean  @default(true)

  // Menu section
  section      MenuSection @default(MAIN)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  permissions  RolePermission[]

  @@index([section])
  @@index([parentId])
}

enum MenuSection {
  MAIN
  ADMIN
  PLATFORM_ADMIN
}

// ============================================================================
// PERMISSIONS (CRUD per Menu per Role)
// ============================================================================

model RolePermission {
  id         Int      @id @default(autoincrement())

  roleId     Int
  menuId     Int

  // CRUD permissions
  canCreate  Boolean  @default(false)
  canRead    Boolean  @default(false)
  canUpdate  Boolean  @default(false)
  canDelete  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  menu       Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuId])
  @@index([roleId])
  @@index([menuId])
}

// ============================================================================
// FEATURE FLAGS
// ============================================================================

model FeatureFlag {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())
  key          String   @unique
  name         String
  description  String?

  // Default state
  defaultEnabled Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organizationOverrides OrganizationFeatureFlag[]

  @@index([key])
}

model OrganizationFeatureFlag {
  id              Int      @id @default(autoincrement())

  organizationId  Int
  featureFlagId   Int

  // Platform Admin sets this
  platformEnabled Boolean  @default(false)

  // Org Admin can turn OFF (but not ON if platform disabled)
  orgEnabled      Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  featureFlag     FeatureFlag  @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureFlagId])
  @@index([organizationId])
}

// ============================================================================
// PLATFORM SETTINGS
// ============================================================================

model PlatformSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  type        SettingType @default(STRING)
  description String?

  // Grouping for UI
  category    String   @default("general")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ============================================================================
// INVITATIONS
// ============================================================================

model Invitation {
  id             Int       @id @default(autoincrement())
  uuid           String    @unique @default(uuid())

  email          String
  organizationId Int
  roleId         Int

  // Invitation token
  token          String    @unique
  expiresAt      DateTime

  // Status
  status         InvitationStatus @default(PENDING)
  acceptedAt     DateTime?

  // Who sent it
  invitedById    Int

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy      User         @relation("InvitationSender", fields: [invitedById], references: [id])

  @@index([token])
  @@index([email])
  @@index([organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// REFRESH TOKENS
// ============================================================================

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Device info for session management
  userAgent String?
  ipAddress String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id             Int      @id @default(autoincrement())

  // Who
  userId         Int?
  userEmail      String?

  // What
  action         String
  entityType     String
  entityId       Int?

  // Context
  organizationId Int?

  // Details
  metadata       Json     @default("{}")
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([createdAt])
}

// ============================================================================
// CONTENT TYPES (Configurable types for content items)
// ============================================================================

model ContentType {
  id             Int          @id @default(autoincrement())
  uuid           String       @unique @default(uuid())

  // Nullable for global/system types, set for org-specific
  organizationId Int?

  name           String
  slug           String
  description    String?

  // UI properties
  icon           String?
  color          String?

  // System types cannot be deleted or modified by org admins
  isSystem       Boolean      @default(false)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId])
  @@index([isActive])
}

// ============================================================================
// ACTIVITY ITEM TYPES (Configurable types for activity items)
// ============================================================================

model ActivityItemType {
  id             Int          @id @default(autoincrement())
  uuid           String       @unique @default(uuid())

  // Nullable for global/system types, set for org-specific
  organizationId Int?

  name           String
  slug           String
  description    String?

  // UI properties
  icon           String?
  color          String?

  // System types cannot be deleted or modified by org admins
  isSystem       Boolean      @default(false)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId])
  @@index([isActive])
}

// ============================================================================
// CONTENT ITEMS (Documents, meeting notes, emails, etc.)
// ============================================================================

model ContentItem {
  id              String    @id @default(uuid())
  projectId       String

  // Plan linkage (multi-select) - array of PlanItem UUIDs
  planItemIds     String[]  @default([])

  // Classification (multi-select) - arrays of type IDs
  contentTypeIds  Int[]     @default([])
  activityTypeIds Int[]     @default([])

  // Source info
  sourceType      String    // file, text, calendar, transcript, email
  title           String

  // Timing - crucial for activity reporting
  dateOccurred    DateTime  @db.Date
  projectWeek     Int?      // Calculated from project.startDate
  tags            String[]  @default([])

  // Raw content storage
  rawContent      String?   @db.Text
  fileReference   String?   // Path if source was file
  fileName        String?
  fileSize        Int?
  mimeType        String?

  // AI processing results
  aiSummary             String?   @db.Text
  aiExtractedEntities   Json      @default("{}")
  processingStatus      String    @default("pending")  // pending, processing, completed, failed

  // Lineage - for AI-split items
  parentItemId    String?
  createdBy       String    @default("user")  // user, ai_split
  createdByUserId Int?

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent          ContentItem?   @relation("ContentItemSplit", fields: [parentItemId], references: [id])
  children        ContentItem[]  @relation("ContentItemSplit")
  user            User?     @relation(fields: [createdByUserId], references: [id])

  @@index([projectId])
  @@index([dateOccurred])
  @@index([projectWeek])
  @@index([processingStatus])
  @@index([isActive])
}
